version: '3.6'

services:
  metastore:
    image: sherlockdatalake/metastore:3.1.1
    ports:
      - 9083:9083
#    networks:
#      - inside
    environment:
      HIVE_DEFAULT_FS: "s3a://sherlock-korcsmaros-group/"
      S3_ACCESS_KEY: "DNVEDQPT726QGMAZURPJ"
      S3_SECRET_KEY: "ki1dDCABLunhZXcAaHFzONOnsJP9aIWLJSf4DewMMV4"
      S3_END_POINT: "ams3.digitaloceanspaces.com"
      DB_JDBC: "jdbc:postgresql://postgres:5432/hive?createDatabaseIfNotExist=true"
      DB_PASSWD: "hive"
      DB_USER: "hive"
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      update_config:
        parallelism: 1
        delay: 30s

  postgres:
    image: postgres:9.6.10
    volumes:
      - metastorepostgresqldata:/var/lib/postgresql
    ports:
      - 5432:5432
#    networks:
#      - inside
    environment:
      POSTGRES_USER: hive
      POSTGRES_PASSWORD: hive
      POSTGRES_DB: hive
    healthcheck:
        test: ["CMD", "pg_isready", "-U", "hive"]
        interval: 5s
        timeout: 5s
        retries: 5
        start_period: 30s
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      update_config:
        parallelism: 1
        delay: 30s

  sherlock-master:
    image: sherlockdatalake/presto:0.213
    environment:
      IS_COORDINATOR: "true"
      DISCOVERY_CONFIG: "discovery-server.enabled=true"
      S3_ACCESS_KEY: "DNVEDQPT726QGMAZURPJ"
      S3_SECRET_KEY: "ki1dDCABLunhZXcAaHFzONOnsJP9aIWLJSf4DewMMV4"
      S3_END_POINT: "ams3.digitaloceanspaces.com"
      QUERY_MAX_MEMORY: "22GB"
      QUERY_MAX_MEMORY_PER_NODE: "6GB"
      QUERY_MAX_TOTAL_MEMORY_PER_NODE: "6GB"
      MEMORY_HEAP_HEADROOM_PER_NODE: "2GB"
      JVM_XMX: "-Xmx10G"
    ports:
      - 8080:8080
#    networks:
#      - inside
    deploy:
      mode: replicated
      replicas: 1
      update_config:
        parallelism: 1
        delay: 30s
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: '2'
          memory: 5.5G
        reservations:
          cpus: '2'
          memory: 5G

  sherlock-worker:
    image: sherlockdatalake/presto:0.213
    environment:
      IS_COORDINATOR: "false"
      DISCOVERY_CONFIG: ""
      S3_ACCESS_KEY: "DNVEDQPT726QGMAZURPJ"
      S3_SECRET_KEY: "ki1dDCABLunhZXcAaHFzONOnsJP9aIWLJSf4DewMMV4"
      S3_END_POINT: "ams3.digitaloceanspaces.com"
      QUERY_MAX_MEMORY: "22GB"
      QUERY_MAX_MEMORY_PER_NODE: "6GB"
      QUERY_MAX_TOTAL_MEMORY_PER_NODE: "6GB"
      MEMORY_HEAP_HEADROOM_PER_NODE: "2GB"
      JVM_XMX: "-Xmx10G"
#    networks:
#      - inside
#      - outside
    deploy:
      mode: replicated
      replicas: 2
      update_config:
        parallelism: 1
        delay: 30s
      resources:
        limits:
          cpus: '2'
          memory: 10.5G
        reservations:
          cpus: '2'
          memory: 5G

volumes:
  metastorepostgresqldata:

#networks:
#  inside:
#    driver: overlay
#  outside:
#    external: false
#    driver: bridge
